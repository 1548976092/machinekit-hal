#!/bin/bash -e
#                                                         -*-shell-script-*-
# Placed into the public domain by John Morris, 2014
#
# Configure source package dependencies

# List of supported kernel arches for kthreads
KTHREAD_ARCHES="i386 amd64"


# Work out of the debian/ directory
cd "$(dirname $0)"

# Put command into a file so that later automatic invocations can
# re-run
echo $0 $* > configure.cmdline

rules_enable_threads() {
    # enable thread flavors in debian/rules; e.g.
    #    THREADS_POSIX = --with-posix
    FLAVOR=$1
    FLAVOR_VAR=THREADS_$(echo $FLAVOR | tr 'a-z-' 'A-Z_')
    sed -i rules \
	-e "s/^${FLAVOR_VAR}[^_].*/${FLAVOR_VAR} = --with-${FLAVOR}/"
    echo "debian/rules:  enabled ${FLAVOR} threads" >&2
}

guess_arch_from_kver() {
    # utility to make a guess at the kernel header arch from the
    # kernel version; this works for Debian kernels, and 'any' is
    # correct for the RTAI kernel packages in the Machinekit Debian
    # archive
    KVER=$1
    case $KVER in
	*-?86 | *-?86-pae) echo i386 ;;
	*-amd64) echo amd64 ;;
	*) echo any ;;  # For non-Debian kernel package naming
    esac
}

do_posix() {
    cat control.posix.in >> control
    echo "debian/control:  added POSIX threads package" >&2
    rules_enable_threads posix
    HAVE_FLAVOR=true
}

do_rt-preempt() {
    cat control.rt-preempt.in >> control
    echo "debian/control:  added RT_PREEMPT threads package" >&2
    rules_enable_threads rt-preempt
    HAVE_FLAVOR=true
}

do_xenomai() {
    # Be sure the -dev files only appear once
    BUILD_DEPS="${BUILD_DEPS/libxenomai-dev, /}libxenomai-dev, "
    cat control.xenomai.in >> control
    echo "debian/control:  added Xenomai (userland) threads package" \
	"with Build-Depends:" >&2
    echo "    libxenomai-dev" >&2
    rules_enable_threads xenomai
    HAVE_FLAVOR=true
}


usage() {
    {
	test -z "$1" || echo "$1"
	echo "Usage:  $0 [ arg ... ]"
	echo "   arg:		function:"
	echo "   -p		build POSIX threads"
	echo "   -r		build RT_PREEMPT threads"
	echo "   -x		build Xenomai threads"
	echo "      *** Argument may be repeated for multiple kernels"
    } >&2
    exit 1
}
test "$1" != --help || usage

#############################################
# Main program
#
# These need to be in a certain order:
# - Base template copy first
# - do_<flavor> functions next
# - replace BUILD_DEPS and *_KERNEL_HEADERS last
#   (when lists are fully populated)

# set defaults
BUILD_DEPS=  # List of Build-Depends
DEPS= # List of Depends
HAVE_FLAVOR=false
HAVE_KTHREADS_FLAVOR=false

# delete old files
rm -f machinekit-hal-{rtai,xenomai}-kernel-*.install

# copy base templates into place
cp control.in control
echo "debian/control:  copied base template" >&2
cp rules.in rules; chmod +x rules
echo "debian/rules:  copied base template" >&2
cp machinekit-hal.install.in machinekit-hal.install
echo "debian/machinekit-hal.install.in:  copied base template" >&2

# read command line options
while getopts prx:?h ARG; do
    case $ARG in
	p) do_posix ;;
	r) do_rt-preempt ;;
	x) do_xenomai ;;
	?|h) usage ;;
	*) usage "Unknown arg: '-$ARG'" ;;
    esac
done

# Set control Build-Depends:
sed -i control \
    -e "s/@BUILD_DEPS@/${BUILD_DEPS}/" \
    -e "s/@DEPS@/${DEPS}/"
echo "debian/control:  add final Build-Depends: list" >&2

# Warn if no flavor configured
$HAVE_FLAVOR || usage "WARNING:  No thread flavors configured"
